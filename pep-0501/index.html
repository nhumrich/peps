
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="color-scheme" content="light dark">
    <title>PEP 501 – General purpose template literal strings | peps.python.org</title>
    <link rel="shortcut icon" href="../_static/py.png">
    <link rel="canonical" href="https://peps.python.org/pep-0501/">
    <link rel="stylesheet" href="../_static/style.css" type="text/css">
    <link rel="stylesheet" href="../_static/mq.css" type="text/css">
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" media="(prefers-color-scheme: light)" id="pyg-light">
    <link rel="stylesheet" href="../_static/pygments_dark.css" type="text/css" media="(prefers-color-scheme: dark)" id="pyg-dark">
    <link rel="alternate" type="application/rss+xml" title="Latest PEPs" href="https://peps.python.org/peps.rss">
    <meta property="og:title" content='PEP 501 – General purpose template literal strings | peps.python.org'>
    <meta property="og:description" content="Though easy and elegant to use, Python f-strings can be vulnerable to injection attacks when used to construct shell commands, SQL queries, HTML snippets and similar (for example, os.system(f&quot;echo {message_from_user}&quot;)). This PEP introduces template lit...">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://peps.python.org/pep-0501/">
    <meta property="og:site_name" content="Python Enhancement Proposals (PEPs)">
    <meta property="og:image" content="https://peps.python.org/_static/og-image.png">
    <meta property="og:image:alt" content="Python PEPs">
    <meta property="og:image:width" content="200">
    <meta property="og:image:height" content="200">
    <meta name="description" content="Though easy and elegant to use, Python f-strings can be vulnerable to injection attacks when used to construct shell commands, SQL queries, HTML snippets and similar (for example, os.system(f&quot;echo {message_from_user}&quot;)). This PEP introduces template lit...">
    <meta name="theme-color" content="#3776ab">
</head>
<body>
    
<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-sun-half" viewBox="0 0 24 24" pointer-events="all">
    <title>Following system colour scheme</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
         stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <circle cx="12" cy="12" r="9"></circle>
      <path d="M12 3v18m0-12l4.65-4.65M12 14.3l7.37-7.37M12 19.6l8.85-8.85"></path>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24" pointer-events="all">
    <title>Selected dark colour scheme</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
         stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z"></path>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24" pointer-events="all">
    <title>Selected light colour scheme</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
         stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
</svg>
    <script>

        document.documentElement.dataset.colour_scheme = localStorage.getItem("colour_scheme") || "auto"
    </script>
    <section id="pep-page-section">
        <header>
            <h1>Python Enhancement Proposals</h1>
            <ul class="breadcrumbs">
                <li><a href="https://www.python.org/" title="The Python Programming Language">Python</a> &raquo; </li>
                <li><a href="../pep-0000/">PEP Index</a> &raquo; </li>
                <li>PEP 501</li>
            </ul>
            <button id="colour-scheme-cycler" onClick="setColourScheme(nextColourScheme())">
                <svg aria-hidden="true" class="colour-scheme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
                <svg aria-hidden="true" class="colour-scheme-icon-when-dark"><use href="#svg-moon"></use></svg>
                <svg aria-hidden="true" class="colour-scheme-icon-when-light"><use href="#svg-sun"></use></svg>
                <span class="visually-hidden">Toggle light / dark / auto colour theme</span>
            </button>
        </header>
        <article>
            <section id="pep-content">
<h1 class="page-title">PEP 501 – General purpose template literal strings</h1>
<dl class="rfc2822 field-list simple">
<dt class="field-odd">Author<span class="colon">:</span></dt>
<dd class="field-odd">Alyssa Coghlan &lt;ncoghlan&#32;&#97;t&#32;gmail.com&gt;, Nick Humrich &lt;nick&#32;&#97;t&#32;humrich.us&gt;</dd>
<dt class="field-even">Discussions-To<span class="colon">:</span></dt>
<dd class="field-even"><a class="reference external" href="https://discuss.python.org/t/pep-501-reopen-general-purpose-string-template-literals/24625">Discourse thread</a></dd>
<dt class="field-odd">Status<span class="colon">:</span></dt>
<dd class="field-odd"><abbr title="Proposal under active discussion and revision">Draft</abbr></dd>
<dt class="field-even">Type<span class="colon">:</span></dt>
<dd class="field-even"><abbr title="Normative PEP with a new feature for Python, implementation change for CPython or interoperability standard for the ecosystem">Standards Track</abbr></dd>
<dt class="field-odd">Requires<span class="colon">:</span></dt>
<dd class="field-odd"><a class="reference external" href="../pep-0701/">701</a></dd>
<dt class="field-even">Created<span class="colon">:</span></dt>
<dd class="field-even">08-Aug-2015</dd>
<dt class="field-odd">Python-Version<span class="colon">:</span></dt>
<dd class="field-odd">3.12</dd>
<dt class="field-even">Post-History<span class="colon">:</span></dt>
<dd class="field-even"><a class="reference external" href="https://mail.python.org/archives/list/python-dev&#64;python.org/thread/EAZ3P2M3CDDIQFR764NF6FXQHWXYMKJF/" title="Python-Dev thread">08-Aug-2015</a>,
<a class="reference external" href="https://mail.python.org/archives/list/python-dev&#64;python.org/thread/ILVRPS6DTFZ7IHL5HONDBB6INVXTFOZ2/" title="Python-Dev thread">05-Sep-2015</a>,
<a class="reference external" href="https://discuss.python.org/t/pep-501-reopen-general-purpose-string-template-literals/24625" title="Discourse thread">09-Mar-2023</a></dd>
</dl>
<hr class="docutils" />
<section id="contents">
<details><summary>Table of Contents</summary><ul class="simple">
<li><a class="reference internal" href="#abstract">Abstract</a></li>
<li><a class="reference internal" href="#motivation">Motivation</a></li>
<li><a class="reference internal" href="#proposal">Proposal</a><ul>
<li><a class="reference internal" href="#summary-of-differences-from-f-strings">Summary of differences from f-strings</a></li>
</ul>
</li>
<li><a class="reference internal" href="#rationale">Rationale</a></li>
<li><a class="reference internal" href="#specification">Specification</a><ul>
<li><a class="reference internal" href="#conversion-specifiers">Conversion specifiers</a></li>
<li><a class="reference internal" href="#writing-custom-renderers">Writing custom renderers</a></li>
<li><a class="reference internal" href="#expression-evaluation">Expression evaluation</a></li>
<li><a class="reference internal" href="#handling-code-injection-attacks">Handling code injection attacks</a></li>
<li><a class="reference internal" href="#format-specifiers">Format specifiers</a></li>
<li><a class="reference internal" href="#error-handling">Error handling</a></li>
</ul>
</li>
<li><a class="reference internal" href="#renderer-for-shell-escaping-added-to-shlex">Renderer for shell escaping added to shlex</a></li>
<li><a class="reference internal" href="#changes-to-subprocess-module">Changes to subprocess module</a></li>
<li><a class="reference internal" href="#possible-integration-with-the-logging-module">Possible integration with the logging module</a></li>
<li><a class="reference internal" href="#comparison-to-pep-675">Comparison to PEP 675</a></li>
<li><a class="reference internal" href="#discussion">Discussion</a><ul>
<li><a class="reference internal" href="#support-for-binary-interpolation">Support for binary interpolation</a></li>
<li><a class="reference internal" href="#interoperability-with-str-only-interfaces">Interoperability with str-only interfaces</a></li>
<li><a class="reference internal" href="#preserving-the-raw-template-string">Preserving the raw template string</a></li>
<li><a class="reference internal" href="#creating-a-rich-object-rather-than-a-global-name-lookup">Creating a rich object rather than a global name lookup</a></li>
<li><a class="reference internal" href="#building-atop-f-strings-rather-than-replacing-them">Building atop f-strings rather than replacing them</a></li>
<li><a class="reference internal" href="#deferring-consideration-of-possible-use-in-i18n-use-cases">Deferring consideration of possible use in i18n use cases</a></li>
</ul>
</li>
<li><a class="reference internal" href="#acknowledgements">Acknowledgements</a></li>
<li><a class="reference internal" href="#references">References</a></li>
<li><a class="reference internal" href="#copyright">Copyright</a></li>
</ul>
</details></section>
<section id="abstract">
<h2><a class="toc-backref" href="#abstract" role="doc-backlink">Abstract</a></h2>
<p>Though easy and elegant to use, Python <a class="reference external" href="https://docs.python.org/3/glossary.html#term-f-string" title="(in Python v3.12)"><span class="xref std std-term">f-string</span></a>s
can be vulnerable to injection attacks when used to construct
shell commands, SQL queries, HTML snippets and similar
(for example, <code class="docutils literal notranslate"><span class="pre">os.system(f&quot;echo</span> <span class="pre">{message_from_user}&quot;)</span></code>).
This PEP introduces template literal strings (or “t-strings”),
which have the same syntax and semantics but with rendering deferred
until <a class="reference external" href="https://docs.python.org/3/library/functions.html#format" title="(in Python v3.12)"><code class="xref py py-func docutils literal notranslate"><span class="pre">format()</span></code></a> or another builder function is called on them.
This will allow standard library calls, helper functions
and third party tools to safety and intelligently perform
appropriate escaping and other string processing on inputs
while retaining the usability and convenience of f-strings.</p>
</section>
<section id="motivation">
<h2><a class="toc-backref" href="#motivation" role="doc-backlink">Motivation</a></h2>
<p><a class="pep reference internal" href="../pep-0498/" title="PEP 498 – Literal String Interpolation">PEP 498</a> added new syntactic support for string interpolation that is
transparent to the compiler, allowing name references from the interpolation
operation full access to containing namespaces (as with any other expression),
rather than being limited to explicit name references. These are referred
to in the PEP as “f-strings” (a mnemonic for “formatted strings”).</p>
<p>Since acceptance of <a class="pep reference internal" href="../pep-0498/" title="PEP 498 – Literal String Interpolation">PEP 498</a>, f-strings have become well-established and very popular.
F-strings are becoming even more useful with the addition of <a class="pep reference internal" href="../pep-0701/" title="PEP 701 – Syntactic formalization of f-strings">PEP 701</a>.
While f-strings are great, eager rendering has its limitations. For example, the eagerness of f-strings
has made code like the following likely:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;echo </span><span class="si">{</span><span class="n">message_from_user</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>This kind of code is superficially elegant, but poses a significant problem
if the interpolated value <code class="docutils literal notranslate"><span class="pre">message_from_user</span></code> is in fact provided by an
untrusted user: it’s an opening for a form of code injection attack, where
the supplied user data has not been properly escaped before being passed to
the <code class="docutils literal notranslate"><span class="pre">os.system</span></code> call.</p>
<p>To address that problem (and a number of other concerns), this PEP proposes
the complementary introduction of “t-strings” (a mnemonic for “template literal strings”),
where <code class="docutils literal notranslate"><span class="pre">f&quot;Message</span> <span class="pre">with</span> <span class="pre">{data}&quot;</span></code> would produce the same
result as <code class="docutils literal notranslate"><span class="pre">format(t&quot;Message</span> <span class="pre">with</span> <span class="pre">{data}&quot;)</span></code>.</p>
<p>While this PEP and <a class="pep reference internal" href="../pep-0675/" title="PEP 675 – Arbitrary Literal String Type">PEP 675</a> are similar in their goals, neither one competes with the other,
and can instead be used together.</p>
<p>This PEP was previously in deferred status, pending further experience with <a class="pep reference internal" href="../pep-0498/" title="PEP 498 – Literal String Interpolation">PEP 498</a>’s
simpler approach of only supporting eager rendering without the additional
complexity of also supporting deferred rendering. Since then, f-strings have become very popular
and <a class="pep reference internal" href="../pep-0701/" title="PEP 701 – Syntactic formalization of f-strings">PEP 701</a> has been introduced. This PEP has been updated to reflect current knowledge of f-strings,
and improvements from 701. It is designed to be built on top of the <a class="pep reference internal" href="../pep-0701/" title="PEP 701 – Syntactic formalization of f-strings">PEP 701</a> implementation.</p>
</section>
<section id="proposal">
<h2><a class="toc-backref" href="#proposal" role="doc-backlink">Proposal</a></h2>
<p>This PEP proposes a new string prefix that declares the
string to be a template literal rather than an ordinary string:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">template</span> <span class="o">=</span> <span class="n">t</span><span class="s2">&quot;Substitute </span><span class="si">{names:&gt;10}</span><span class="s2"> and {expressions()} at runtime&quot;</span>
</pre></div>
</div>
<p>This would be effectively interpreted as:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">_raw_template</span> <span class="o">=</span> <span class="s2">&quot;Substitute </span><span class="si">{names:&gt;10}</span><span class="s2"> and {expressions()} at runtime&quot;</span>
<span class="n">_parsed_template</span> <span class="o">=</span> <span class="p">(</span>
    <span class="p">(</span><span class="s2">&quot;Substitute &quot;</span><span class="p">,</span> <span class="s2">&quot;names&quot;</span><span class="p">),</span>
    <span class="p">(</span><span class="s2">&quot; and &quot;</span><span class="p">,</span> <span class="s2">&quot;expressions()&quot;</span><span class="p">),</span>
    <span class="p">(</span><span class="s2">&quot; at runtime&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
<span class="p">)</span>
<span class="n">_field_values</span> <span class="o">=</span> <span class="p">(</span><span class="n">names</span><span class="p">,</span> <span class="n">expressions</span><span class="p">())</span>
<span class="n">_format_specifiers</span> <span class="o">=</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&gt;10&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
<span class="n">template</span> <span class="o">=</span> <span class="n">types</span><span class="o">.</span><span class="n">TemplateLiteral</span><span class="p">(</span>
    <span class="n">_raw_template</span><span class="p">,</span> <span class="n">_parsed_template</span><span class="p">,</span> <span class="n">_field_values</span><span class="p">,</span> <span class="n">_format_specifiers</span><span class="p">)</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">__format__</span></code> method on <code class="docutils literal notranslate"><span class="pre">types.TemplateLiteral</span></code> would then
implement the following <a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str.format" title="(in Python v3.12)"><code class="xref py py-meth docutils literal notranslate"><span class="pre">str.format()</span></code></a> inspired semantics:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">datetime</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;Jane&#39;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">age</span> <span class="o">=</span> <span class="mi">50</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">anniversary</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">(</span><span class="mi">1991</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">12</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">format</span><span class="p">(</span><span class="n">t</span><span class="s1">&#39;My name is </span><span class="si">{name}</span><span class="s1">, my age next year is {age+1}, my anniversary is {anniversary:%A, %B </span><span class="si">%d</span><span class="s1">, %Y}.&#39;</span><span class="p">)</span>
<span class="go">&#39;My name is Jane, my age next year is 51, my anniversary is Saturday, October 12, 1991.&#39;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">format</span><span class="p">(</span><span class="n">t</span><span class="s1">&#39;She said her name is </span><span class="si">{name!r}</span><span class="s1">.&#39;</span><span class="p">)</span>
<span class="go">&quot;She said her name is &#39;Jane&#39;.&quot;</span>
</pre></div>
</div>
<p>The implementation of template literals would be based on <a class="pep reference internal" href="../pep-0701/" title="PEP 701 – Syntactic formalization of f-strings">PEP 701</a>, and use the same syntax.</p>
<p>This PEP does not propose to remove or deprecate any of the existing
string formatting mechanisms, as those will remain valuable when formatting
strings that are not present directly in the source code of the application.</p>
<section id="summary-of-differences-from-f-strings">
<h3><a class="toc-backref" href="#summary-of-differences-from-f-strings" role="doc-backlink">Summary of differences from f-strings</a></h3>
<p>The key differences between f-strings and t-strings are:</p>
<ul class="simple">
<li>the <code class="docutils literal notranslate"><span class="pre">t</span></code> (template literal) prefix indicates delayed rendering, but
otherwise uses the same syntax and semantics as formatted strings</li>
<li>template literals are available at runtime as a new kind of object
(<code class="docutils literal notranslate"><span class="pre">types.TemplateLiteral</span></code>)</li>
<li>the default rendering used by formatted strings is invoked on a
template literal object by calling <code class="docutils literal notranslate"><span class="pre">format(template)</span></code> rather than
implicitly</li>
<li>while  f-string <code class="docutils literal notranslate"><span class="pre">f&quot;Message</span> <span class="pre">{here}&quot;</span></code> would be <em>semantically</em> equivalent to
<code class="docutils literal notranslate"><span class="pre">format(t&quot;Message</span> <span class="pre">{here}&quot;)</span></code>, f-strings will continue to avoid the runtime overhead of using
the delayed rendering machinery that is needed for t-strings</li>
</ul>
</section>
</section>
<section id="rationale">
<h2><a class="toc-backref" href="#rationale" role="doc-backlink">Rationale</a></h2>
<p>F-strings (<a class="pep reference internal" href="../pep-0498/" title="PEP 498 – Literal String Interpolation">PEP 498</a>) made interpolating values into strings with full access to Python’s
lexical namespace semantics simpler, but it does so at the cost of creating a
situation where interpolating values into sensitive targets like SQL queries,
shell commands and HTML templates will enjoy a much cleaner syntax when handled
without regard for code injection attacks than when they are handled correctly.</p>
<p>This PEP proposes to provide the option of delaying the actual rendering
of a template literal to its <code class="docutils literal notranslate"><span class="pre">__format__</span></code> method, allowing the use of
other template renderers by passing the template around as a first class object.</p>
<p>While very different in the technical details, the
<code class="docutils literal notranslate"><span class="pre">types.TemplateLiteral</span></code> interface proposed in this PEP is
conceptually quite similar to the <code class="docutils literal notranslate"><span class="pre">FormattableString</span></code> type underlying the
<a class="reference external" href="https://msdn.microsoft.com/en-us/library/dn961160.aspx">native interpolation</a> support introduced in C# 6.0,
as well as <a class="reference external" href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Template_literals">template literals in Javascript</a> introduced in ES6.</p>
</section>
<section id="specification">
<h2><a class="toc-backref" href="#specification" role="doc-backlink">Specification</a></h2>
<p>This PEP proposes a new <code class="docutils literal notranslate"><span class="pre">t</span></code> string prefix that
results in the creation of an instance of a new type,
<code class="docutils literal notranslate"><span class="pre">types.TemplateLiteral</span></code>.</p>
<p>Template literals are Unicode strings (bytes literals are not
permitted), and string literal concatenation operates as normal, with the
entire combined literal forming the template literal.</p>
<p>The template string is parsed into literals, expressions and format specifiers
as described for f-strings in <a class="pep reference internal" href="../pep-0498/" title="PEP 498 – Literal String Interpolation">PEP 498</a> and <a class="pep reference internal" href="../pep-0701/" title="PEP 701 – Syntactic formalization of f-strings">PEP 701</a>. Conversion specifiers are handled
by the compiler, and appear as part of the field text in interpolation
templates.</p>
<p>However, rather than being rendered directly into a formatted string, these
components are instead organised into an instance of a new type with the
following semantics:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">TemplateLiteral</span><span class="p">:</span>
    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;raw_template&quot;</span><span class="p">,</span> <span class="s2">&quot;parsed_template&quot;</span><span class="p">,</span> <span class="s2">&quot;field_values&quot;</span><span class="p">,</span> <span class="s2">&quot;format_specifiers&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">raw_template</span><span class="p">,</span> <span class="n">parsed_template</span><span class="p">,</span> <span class="n">field_values</span><span class="p">,</span> <span class="n">format_specifiers</span><span class="p">):</span>
        <span class="bp">self</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">raw_template</span> <span class="o">=</span> <span class="n">raw_template</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">parsed_template</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;&#39;parsed_template&#39; must contain at least one value&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parsed_template</span> <span class="o">=</span> <span class="n">parsed_template</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">field_values</span> <span class="o">=</span> <span class="n">field_values</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">format_specifiers</span> <span class="o">=</span> <span class="n">format_specifiers</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="fm">__bool__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">raw_template</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__add__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">TemplateLiteral</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">parsed_template</span>
                <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">parsed_template</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span>
                <span class="ow">and</span> <span class="n">other</span><span class="o">.</span><span class="n">parsed_template</span>
            <span class="p">):</span>
                <span class="c1"># merge the last string of self with the first string of other</span>
                <span class="n">content</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parsed_template</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">new_parsed_template</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">parsed_template</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                    <span class="o">+</span> <span class="p">(</span>
                        <span class="p">(</span>
                            <span class="n">content</span> <span class="o">+</span> <span class="n">other</span><span class="o">.</span><span class="n">parsed_template</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                            <span class="n">other</span><span class="o">.</span><span class="n">parsed_template</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span>
                        <span class="p">),</span>
                    <span class="p">)</span>
                    <span class="o">+</span> <span class="n">other</span><span class="o">.</span><span class="n">parsed_template</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
                <span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">new_parsed_template</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parsed_template</span> <span class="o">+</span> <span class="n">other</span><span class="o">.</span><span class="n">parsed_template</span>

            <span class="k">return</span> <span class="n">TemplateLiteral</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">raw_template</span> <span class="o">+</span> <span class="n">other</span><span class="o">.</span><span class="n">raw_template</span><span class="p">,</span>
                <span class="n">new_parsed_template</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">field_values</span> <span class="o">+</span> <span class="n">other</span><span class="o">.</span><span class="n">field_values</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">format_specifiers</span> <span class="o">+</span> <span class="n">other</span><span class="o">.</span><span class="n">format_specifiers</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parsed_template</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">parsed_template</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># merge string with last value</span>
                <span class="n">new_parsed_template</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parsed_template</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span>
                    <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parsed_template</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">other</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">new_parsed_template</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parsed_template</span> <span class="o">+</span> <span class="p">((</span><span class="n">other</span><span class="p">,</span> <span class="kc">None</span><span class="p">),)</span>

            <span class="k">return</span> <span class="n">TemplateLiteral</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">raw_template</span> <span class="o">+</span> <span class="n">other</span><span class="p">,</span>
                <span class="n">new_parsed_template</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">field_values</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">format_specifiers</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;unsupported operand type(s) for +: &#39;</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="si">}</span><span class="s2">&#39; and &#39;</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">other</span><span class="p">)</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
            <span class="p">)</span>

    <span class="k">def</span> <span class="fm">__radd__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parsed_template</span><span class="p">:</span>
                <span class="n">new_parsed_template</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="p">(</span><span class="n">other</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">parsed_template</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">parsed_template</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]),</span>
                <span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">parsed_template</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">new_parsed_template</span> <span class="o">=</span> <span class="p">((</span><span class="n">other</span><span class="p">,</span> <span class="kc">None</span><span class="p">),)</span>

            <span class="k">return</span> <span class="n">TemplateLiteral</span><span class="p">(</span>
                <span class="n">other</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">raw_template</span><span class="p">,</span>
                <span class="n">new_parsed_template</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">field_values</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">format_specifiers</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;unsupported operand type(s) for +: &#39;</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">other</span><span class="p">)</span><span class="si">}</span><span class="s2">&#39; and &#39;</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
            <span class="p">)</span>

    <span class="k">def</span> <span class="fm">__mul__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">raw_template</span> <span class="ow">or</span> <span class="n">other</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span>
            <span class="k">if</span> <span class="n">other</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">TemplateLiteral</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="p">(),</span> <span class="p">())</span>
            <span class="n">parsed_template</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parsed_template</span>
            <span class="n">last_node</span> <span class="o">=</span> <span class="n">parsed_template</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">trailing_field</span> <span class="o">=</span> <span class="n">last_node</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">trailing_field</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># With a trailing field, everything can just be repeated the requested number of times</span>
                <span class="n">new_parsed_template</span> <span class="o">=</span> <span class="n">parsed_template</span> <span class="o">*</span> <span class="n">other</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Without a trailing field, need to amend the parsed template repetitions to merge</span>
                <span class="c1"># the trailing text from each repetition with the leading text of the next</span>
                <span class="n">first_node</span> <span class="o">=</span> <span class="n">parsed_template</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">merged_node</span> <span class="o">=</span> <span class="p">(</span><span class="n">last_node</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">first_node</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">first_node</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">repeating_pattern</span> <span class="o">=</span> <span class="n">parsed_template</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">merged_node</span>
                <span class="n">new_parsed_template</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">parsed_template</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                    <span class="o">+</span> <span class="p">(</span><span class="n">repeating_pattern</span> <span class="o">*</span> <span class="p">(</span><span class="n">other</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                    <span class="o">+</span> <span class="n">last_node</span>
                <span class="p">)</span>
            <span class="k">return</span> <span class="n">TemplateLiteral</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">raw_template</span> <span class="o">*</span> <span class="n">other</span><span class="p">,</span>
                <span class="n">new_parsed_template</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">field_values</span> <span class="o">*</span> <span class="n">other</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">format_specifiers</span> <span class="o">*</span> <span class="n">other</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;unsupported operand type(s) for *: &#39;</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="si">}</span><span class="s2">&#39; and &#39;</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">other</span><span class="p">)</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
            <span class="p">)</span>

    <span class="k">def</span> <span class="fm">__rmul__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span> <span class="o">*</span> <span class="n">other</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;unsupported operand type(s) for *: &#39;</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">other</span><span class="p">)</span><span class="si">}</span><span class="s2">&#39; and &#39;</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
            <span class="p">)</span>

    <span class="k">def</span> <span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">TemplateLiteral</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">raw_template</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">raw_template</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">parsed_template</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">parsed_template</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">field_values</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">field_values</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">format_specifiers</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">format_specifiers</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;&lt;</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="vm">__qualname__</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">raw_template</span><span class="p">)</span><span class="si">}</span><span class="s2"> &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;at </span><span class="si">{</span><span class="nb">id</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="si">:</span><span class="s2">#x</span><span class="si">}</span><span class="s2">&gt;&quot;</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="fm">__format__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">format_specifier</span><span class="p">):</span>
        <span class="c1"># When formatted, render to a string, and use string formatting</span>
        <span class="k">return</span> <span class="nb">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">render</span><span class="p">(),</span> <span class="n">format_specifier</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">render</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">render_template</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">,</span> <span class="n">render_field</span><span class="o">=</span><span class="nb">format</span><span class="p">):</span>
        <span class="o">...</span>  <span class="c1"># See definition of the template rendering semantics below</span>
</pre></div>
</div>
<p>The result of a template literal expression is an instance of this
type, rather than an already rendered string — rendering only takes
place when the instance’s <code class="docutils literal notranslate"><span class="pre">render</span></code> method is called (either directly, or
indirectly via <code class="docutils literal notranslate"><span class="pre">__format__</span></code>).</p>
<p>The compiler will pass the following details to the template literal for
later use:</p>
<ul class="simple">
<li>a string containing the raw template as written in the source code</li>
<li>a parsed template tuple that allows the renderer to render the
template without needing to reparse the raw string template for substitution
fields</li>
<li>a tuple containing the evaluated field values, in field substitution order</li>
<li>a tuple containing the field format specifiers, in field substitution order</li>
</ul>
<p>This structure is designed to take full advantage of compile time constant
folding by ensuring the parsed template is always constant, even when the
field values and format specifiers include variable substitution expressions.</p>
<p>The raw template is just the template literal as a string. By default,
it is used to provide a human-readable representation for the
template literal.</p>
<p>The parsed template consists of a tuple of 2-tuples, with each 2-tuple
containing the following fields:</p>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">leading_text</span></code>:  a leading string literal. This will be the empty string if
the current field is at the start of the string, or immediately follows the
preceding field.</li>
<li><code class="docutils literal notranslate"><span class="pre">field_expr</span></code>: the text of the expression element in the substitution field.
This will be None for a final trailing text segment.</li>
</ul>
<p>The tuple of evaluated field values holds the <em>results</em> of evaluating the
substitution expressions in the scope where the template literal appears.</p>
<p>The tuple of field specifiers holds the <em>results</em> of evaluating the field
specifiers as f-strings in the scope where the template literal appears.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">TemplateLiteral.render</span></code> implementation then defines the rendering
process in terms of the following renderers:</p>
<ul class="simple">
<li>an overall <code class="docutils literal notranslate"><span class="pre">render_template</span></code> operation that defines how the sequence of
literal template sections and rendered fields are composed into a fully
rendered result. The default template renderer is string concatenation
using <code class="docutils literal notranslate"><span class="pre">''.join</span></code>.</li>
<li>a per field <code class="docutils literal notranslate"><span class="pre">render_field</span></code> operation that receives the field value and
format specifier for substitution fields within the template. The default
field renderer is the <code class="docutils literal notranslate"><span class="pre">format</span></code> builtin.</li>
</ul>
<p>Given an appropriate parsed template representation and internal methods of
iterating over it, the semantics of template rendering would then be equivalent
to the following:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">render</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">render_template</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">,</span>
                    <span class="n">render_field</span><span class="o">=</span><span class="nb">format</span><span class="p">):</span>
    <span class="n">iter_fields</span> <span class="o">=</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parsed_template</span><span class="p">)</span>
    <span class="n">values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">field_values</span>
    <span class="n">specifiers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">format_specifiers</span>
    <span class="n">template_parts</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">field_pos</span><span class="p">,</span> <span class="p">(</span><span class="n">leading_text</span><span class="p">,</span> <span class="n">field_expr</span><span class="p">)</span> <span class="ow">in</span> <span class="n">iter_fields</span><span class="p">:</span>
        <span class="n">template_parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">leading_text</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">field_expr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">values</span><span class="p">[</span><span class="n">field_pos</span><span class="p">]</span>
            <span class="n">specifier</span> <span class="o">=</span> <span class="n">specifiers</span><span class="p">[</span><span class="n">field_pos</span><span class="p">]</span>
            <span class="n">rendered_field</span> <span class="o">=</span> <span class="n">render_field</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">specifier</span><span class="p">)</span>
            <span class="n">template_parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rendered_field</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="n">template_parts</span><span class="p">)</span>
</pre></div>
</div>
<section id="conversion-specifiers">
<h3><a class="toc-backref" href="#conversion-specifiers" role="doc-backlink">Conversion specifiers</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">!a</span></code>, <code class="docutils literal notranslate"><span class="pre">!r</span></code> and <code class="docutils literal notranslate"><span class="pre">!s</span></code> conversion specifiers supported by <code class="docutils literal notranslate"><span class="pre">str.format</span></code>
and hence <a class="pep reference internal" href="../pep-0498/" title="PEP 498 – Literal String Interpolation">PEP 498</a> are handled in template literals as follows:</p>
<ul class="simple">
<li>they’re included unmodified in the raw template to ensure no information is
lost</li>
<li>they’re <em>replaced</em> in the parsed template with the corresponding builtin
calls, in order to ensure that <code class="docutils literal notranslate"><span class="pre">field_expr</span></code> always contains a valid
Python expression</li>
<li>the corresponding field value placed in the field values tuple is
converted appropriately <em>before</em> being passed to the template literal</li>
</ul>
<p>This means that, for most purposes, the difference between the use of
conversion specifiers and calling the corresponding builtins in the
original template literal will be transparent to custom renderers. The
difference will only be apparent if reparsing the raw template, or attempting
to reconstruct the original template from the parsed template.</p>
</section>
<section id="writing-custom-renderers">
<h3><a class="toc-backref" href="#writing-custom-renderers" role="doc-backlink">Writing custom renderers</a></h3>
<p>Writing a custom renderer doesn’t require any special syntax. Instead,
custom renderers are ordinary callables that process an interpolation
template directly either by calling the <code class="docutils literal notranslate"><span class="pre">render()</span></code> method with alternate <code class="docutils literal notranslate"><span class="pre">render_template</span></code> or <code class="docutils literal notranslate"><span class="pre">render_field</span></code> implementations, or by accessing the
template’s data attributes directly.</p>
<p>For example, the following function would render a template using objects’
<code class="docutils literal notranslate"><span class="pre">repr</span></code> implementations rather than their native formatting support:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">reprformat</span><span class="p">(</span><span class="n">template</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">render_field</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">specifier</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">format</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">value</span><span class="p">),</span> <span class="n">specifier</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">template</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">render_field</span><span class="o">=</span><span class="n">render_field</span><span class="p">)</span>
</pre></div>
</div>
<p>When writing custom renderers, note that the return type of the overall
rendering operation is determined by the return type of the passed in <code class="docutils literal notranslate"><span class="pre">render_template</span></code> callable. While this is expected to be a string in most
cases, producing non-string objects <em>is</em> permitted. For example, a custom
template renderer could involve an <code class="docutils literal notranslate"><span class="pre">sqlalchemy.sql.text</span></code> call that produces
an <a class="reference external" href="http://docs.sqlalchemy.org/en/rel_1_0/core/tutorial.html#using-textual-sql">SQL Alchemy query object</a>.</p>
<p>Non-strings may also be returned from <code class="docutils literal notranslate"><span class="pre">render_field</span></code>, as long as it is paired
with a <code class="docutils literal notranslate"><span class="pre">render_template</span></code> implementation that expects that behaviour.</p>
</section>
<section id="expression-evaluation">
<h3><a class="toc-backref" href="#expression-evaluation" role="doc-backlink">Expression evaluation</a></h3>
<p>As with f-strings, the subexpressions that are extracted from the interpolation
template are evaluated in the context where the template literal
appears. This means the expression has full access to local, nonlocal and global variables.
Any valid Python expression can be used inside <code class="docutils literal notranslate"><span class="pre">{}</span></code>, including
function and method calls.</p>
<p>Because the substitution expressions are evaluated where the string appears in
the source code, there are no additional security concerns related to the
contents of the expression itself, as you could have also just written the
same expression and used runtime field parsing:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">bar</span><span class="o">=</span><span class="mi">10</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">def</span> <span class="nf">foo</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
<span class="gp">... </span>  <span class="k">return</span> <span class="n">data</span> <span class="o">+</span> <span class="mi">20</span>
<span class="gp">...</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">str</span><span class="p">(</span><span class="n">t</span><span class="s1">&#39;input=</span><span class="si">{bar}</span><span class="s1">, output={foo(bar)}&#39;</span><span class="p">)</span>
<span class="go">&#39;input=10, output=30&#39;</span>
</pre></div>
</div>
<p>Is essentially equivalent to:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="s1">&#39;input=</span><span class="si">{}</span><span class="s1">, output=</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">bar</span><span class="p">,</span> <span class="n">foo</span><span class="p">(</span><span class="n">bar</span><span class="p">))</span>
<span class="go">&#39;input=10, output=30&#39;</span>
</pre></div>
</div>
</section>
<section id="handling-code-injection-attacks">
<h3><a class="toc-backref" href="#handling-code-injection-attacks" role="doc-backlink">Handling code injection attacks</a></h3>
<p>The <a class="pep reference internal" href="../pep-0498/" title="PEP 498 – Literal String Interpolation">PEP 498</a> formatted string syntax makes it potentially attractive to write
code like the following:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">runquery</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;SELECT </span><span class="si">{</span><span class="n">column</span><span class="si">}</span><span class="s2"> FROM </span><span class="si">{</span><span class="n">table</span><span class="si">}</span><span class="s2">;&quot;</span><span class="p">)</span>
<span class="n">runcommand</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;cat </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="n">return_response</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&lt;html&gt;&lt;body&gt;</span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">body</span><span class="si">}</span><span class="s2">&lt;/body&gt;&lt;/html&gt;&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>These all represent potential vectors for code injection attacks, if any of the
variables being interpolated happen to come from an untrusted source. The
specific proposal in this PEP is designed to make it straightforward to write
use case specific renderers that take care of quoting interpolated values
appropriately for the relevant security context:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">runquery</span><span class="p">(</span><span class="n">sql</span><span class="p">(</span><span class="n">t</span><span class="s2">&quot;SELECT </span><span class="si">{column}</span><span class="s2"> FROM </span><span class="si">{table}</span><span class="s2"> WHERE column=</span><span class="si">{value}</span><span class="s2">;&quot;</span><span class="p">))</span>
<span class="n">runcommand</span><span class="p">(</span><span class="n">sh</span><span class="p">(</span><span class="n">t</span><span class="s2">&quot;cat </span><span class="si">{filename}</span><span class="s2">&quot;</span><span class="p">))</span>
<span class="n">return_response</span><span class="p">(</span><span class="n">html</span><span class="p">(</span><span class="n">t</span><span class="s2">&quot;&lt;html&gt;&lt;body&gt;</span><span class="si">{response.body}</span><span class="s2">&lt;/body&gt;&lt;/html&gt;&quot;</span><span class="p">))</span>
</pre></div>
</div>
<p>This PEP does not cover adding all such renderers to the standard library
immediately (though one for shell escaping is proposed), but rather proposes to ensure that they can be readily provided by
third party libraries, and potentially incorporated into the standard library
at a later date.</p>
<p>It is proposed that a renderer is included in the <a class="reference external" href="https://docs.python.org/3/library/shlex.html#module-shlex" title="(in Python v3.12)"><code class="xref py py-mod docutils literal notranslate"><span class="pre">shlex</span></code></a> module, aimed to offer a POSIX shell style experience for
accessing external programs, without the significant risks posed by running
<code class="docutils literal notranslate"><span class="pre">os.system</span></code> or enabling the system shell when using the <code class="docutils literal notranslate"><span class="pre">subprocess</span></code> module
APIs, which will provide an interface for running external programs inspired by that
offered by the
<a class="reference external" href="https://docs.julialang.org/en/v1/manual/running-external-programs/">Julia programming language</a>,
only with the backtick based <code class="docutils literal notranslate"><span class="pre">\`cat</span> <span class="pre">$filename\`</span></code> syntax replaced by
<code class="docutils literal notranslate"><span class="pre">t&quot;cat</span> <span class="pre">{filename}&quot;</span></code> style template literals.
See more in the <a class="reference internal" href="#shlex-module"><span class="std std-ref">Renderer for shell escaping added to shlex</span></a> section.</p>
</section>
<section id="format-specifiers">
<h3><a class="toc-backref" href="#format-specifiers" role="doc-backlink">Format specifiers</a></h3>
<p>Aside from separating them out from the substitution expression during parsing,
format specifiers are otherwise treated as opaque strings by the interpolation
template parser - assigning semantics to those (or, alternatively,
prohibiting their use) is handled at runtime by the field renderer.</p>
</section>
<section id="error-handling">
<h3><a class="toc-backref" href="#error-handling" role="doc-backlink">Error handling</a></h3>
<p>Either compile time or run time errors can occur when processing interpolation
expressions. Compile time errors are limited to those errors that can be
detected when parsing a template string into its component tuples. These
errors all raise SyntaxError.</p>
<p>Unmatched braces:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">t</span><span class="s1">&#39;x={x&#39;</span>
  File <span class="nb">&quot;&lt;stdin&gt;&quot;</span>, line <span class="m">1</span>
<span class="w">    </span>  <span class="n">t</span><span class="s1">&#39;x={x&#39;</span>
<span class="w">         </span><span class="pm">^</span>
<span class="gr">SyntaxError</span>: <span class="n">missing &#39;}&#39; in template literal expression</span>
</pre></div>
</div>
<p>Invalid expressions:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>&gt;&gt;&gt; t&#39;x={!x}&#39;
  File &quot;&lt;fstring&gt;&quot;, line 1
    !x
    ^
SyntaxError: invalid syntax
</pre></div>
</div>
<p>Run time errors occur when evaluating the expressions inside a
template string before creating the template literal object. See <a class="pep reference internal" href="../pep-0498/" title="PEP 498 – Literal String Interpolation">PEP 498</a>
for some examples.</p>
<p>Different renderers may also impose additional runtime
constraints on acceptable interpolated expressions and other formatting
details, which will be reported as runtime exceptions.</p>
</section>
</section>
<section id="renderer-for-shell-escaping-added-to-shlex">
<span id="shlex-module"></span><h2><a class="toc-backref" href="#renderer-for-shell-escaping-added-to-shlex" role="doc-backlink">Renderer for shell escaping added to shlex</a></h2>
<p>As a reference implementation, a renderer for safe POSIX shell escaping can be added to the <a class="reference external" href="https://docs.python.org/3/library/shlex.html#module-shlex" title="(in Python v3.12)"><code class="xref py py-mod docutils literal notranslate"><span class="pre">shlex</span></code></a>
module. This renderer would be called <code class="docutils literal notranslate"><span class="pre">sh</span></code> and would be equivalent to calling <code class="docutils literal notranslate"><span class="pre">shlex.quote</span></code> on
each field value in the template literal.</p>
<p>Thus:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="n">shlex</span><span class="o">.</span><span class="n">sh</span><span class="p">(</span><span class="n">t</span><span class="s1">&#39;cat </span><span class="si">{myfile}</span><span class="s1">&#39;</span><span class="p">))</span>
</pre></div>
</div>
<p>would have the same behavior as:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s1">&#39;cat &#39;</span> <span class="o">+</span> <span class="n">shlex</span><span class="o">.</span><span class="n">quote</span><span class="p">(</span><span class="n">myfile</span><span class="p">)))</span>
</pre></div>
</div>
<p>The implementation would be:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">sh</span><span class="p">(</span><span class="n">template</span><span class="p">:</span> <span class="n">TemplateLiteral</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">template</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">render_field</span><span class="o">=</span><span class="n">quote</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="changes-to-subprocess-module">
<h2><a class="toc-backref" href="#changes-to-subprocess-module" role="doc-backlink">Changes to subprocess module</a></h2>
<p>With the additional renderer in the shlex module, and the addition of template literals,
the <a class="reference external" href="https://docs.python.org/3/library/subprocess.html#module-subprocess" title="(in Python v3.12)"><code class="xref py py-mod docutils literal notranslate"><span class="pre">subprocess</span></code></a> module can be changed to handle accepting template literals
as an additional input type to <code class="docutils literal notranslate"><span class="pre">Popen</span></code>, as it already accepts a sequence, or a string,
with different behavior for each.
With the addition of template literals, <a class="reference external" href="https://docs.python.org/3/library/subprocess.html#subprocess.Popen" title="(in Python v3.12)"><code class="xref py py-class docutils literal notranslate"><span class="pre">subprocess.Popen</span></code></a> (and in return, all its higher level functions such as <a class="reference external" href="https://docs.python.org/3/library/subprocess.html#subprocess.run" title="(in Python v3.12)"><code class="xref py py-func docutils literal notranslate"><span class="pre">run()</span></code></a>)
could accept strings in a safe way.
For example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">t</span><span class="s1">&#39;cat </span><span class="si">{myfile}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<p>would automatically use the <code class="docutils literal notranslate"><span class="pre">shlex.sh</span></code> renderer provided in this PEP. Therefore, using shlex
inside a <code class="docutils literal notranslate"><span class="pre">subprocess.run</span></code> call like so:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">shlex</span><span class="o">.</span><span class="n">sh</span><span class="p">(</span><span class="n">t</span><span class="s1">&#39;cat </span><span class="si">{myfile}</span><span class="s1">&#39;</span><span class="p">),</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<p>would be redundant, as <code class="docutils literal notranslate"><span class="pre">run</span></code> would automatically render any template literals through <code class="docutils literal notranslate"><span class="pre">shlex.sh</span></code></p>
<p>Alternatively, when <code class="docutils literal notranslate"><span class="pre">subprocess.Popen</span></code> is run without <code class="docutils literal notranslate"><span class="pre">shell=True</span></code>, it could still provide
subprocess with a more ergonomic syntax. For example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">t</span><span class="s1">&#39;cat </span><span class="si">{myfile}</span><span class="s1"> --flag </span><span class="si">{value}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>would be equivalent to:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">([</span><span class="s1">&#39;cat&#39;</span><span class="p">,</span> <span class="n">myfile</span><span class="p">,</span> <span class="s1">&#39;--flag&#39;</span><span class="p">,</span> <span class="n">value</span><span class="p">])</span>
</pre></div>
</div>
<p>or, more accurately:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">shlex</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;cat </span><span class="si">{</span><span class="n">shlex</span><span class="o">.</span><span class="n">quote</span><span class="p">(</span><span class="n">myfile</span><span class="p">)</span><span class="si">}</span><span class="s1"> --flag </span><span class="si">{</span><span class="n">shlex</span><span class="o">.</span><span class="n">quote</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">))</span>
</pre></div>
</div>
<p>It would do this by first using the <code class="docutils literal notranslate"><span class="pre">shlex.sh</span></code> renderer, as above, then using <code class="docutils literal notranslate"><span class="pre">shlex.split</span></code> on the result.</p>
<p>The implementation inside <code class="docutils literal notranslate"><span class="pre">subprocess.Popen._execute_child</span></code> would look like:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">TemplateLiteral</span><span class="p">):</span>
  <span class="kn">import</span> <span class="nn">shlex</span>
  <span class="k">if</span> <span class="n">shell</span><span class="p">:</span>
    <span class="n">args</span> <span class="o">=</span> <span class="p">[</span><span class="n">shlex</span><span class="o">.</span><span class="n">sh</span><span class="p">(</span><span class="n">args</span><span class="p">)]</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">shlex</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">shlex</span><span class="o">.</span><span class="n">sh</span><span class="p">(</span><span class="n">args</span><span class="p">))</span>
</pre></div>
</div>
</section>
<section id="possible-integration-with-the-logging-module">
<h2><a class="toc-backref" href="#possible-integration-with-the-logging-module" role="doc-backlink">Possible integration with the logging module</a></h2>
<p>One of the challenges with the logging module has been that we have previously
been unable to devise a reasonable migration strategy away from the use of
printf-style formatting. The runtime parsing and interpolation overhead for
logging messages also poses a problem for extensive logging of runtime events
for monitoring purposes.</p>
<p>While beyond the scope of this initial PEP, template literal support
could potentially be added to the logging module’s event reporting APIs,
permitting relevant details to be captured using forms like:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">t</span><span class="s2">&quot;Event: </span><span class="si">{event}</span><span class="s2">; Details: </span><span class="si">{data}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="n">logging</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="n">t</span><span class="s2">&quot;Error: </span><span class="si">{error}</span><span class="s2">; Details: </span><span class="si">{data}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>Rather than the current mod-formatting style:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Event: </span><span class="si">%s</span><span class="s2">; Details: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
<span class="n">logging</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="s2">&quot;Error: </span><span class="si">%s</span><span class="s2">; Details: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
</pre></div>
</div>
<p>As the template literal is passed in as an ordinary argument, other
keyword arguments would also remain available:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">logging</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="n">t</span><span class="s2">&quot;Error: </span><span class="si">{error}</span><span class="s2">; Details: </span><span class="si">{data}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<p>As part of any such integration, a recommended approach would need to be
defined for “lazy evaluation” of interpolated fields, as the <code class="docutils literal notranslate"><span class="pre">logging</span></code>
module’s existing delayed interpolation support provides access to
<a class="reference external" href="https://docs.python.org/3/library/logging.html#logrecord-attributes" title="(in Python v3.12)"><span class="xref std std-ref">various attributes</span></a> of the event <code class="docutils literal notranslate"><span class="pre">LogRecord</span></code> instance.</p>
<p>For example, since template literal expressions are arbitrary Python expressions,
string literals could be used to indicate cases where evaluation itself is
being deferred, not just rendering:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">t</span><span class="s2">&quot;Logger: {&#39;record.name&#39;}; Event: </span><span class="si">{event}</span><span class="s2">; Details: </span><span class="si">{data}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>This could be further extended with idioms like using inline tuples to indicate
deferred function calls to be made only if the log message is actually
going to be rendered at current logging levels:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">t</span><span class="s2">&quot;Event: </span><span class="si">{event}</span><span class="s2">; Details: {expensive_call, raw_data}&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>This kind of approach would be possible as having access to the actual <em>text</em>
of the field expression would allow the logging renderer to distinguish
between inline tuples that appear in the field expression itself, and tuples
that happen to be passed in as data values in a normal field.</p>
</section>
<section id="comparison-to-pep-675">
<h2><a class="toc-backref" href="#comparison-to-pep-675" role="doc-backlink">Comparison to PEP 675</a></h2>
<p>This PEP has similar goals to <a class="pep reference internal" href="../pep-0675/" title="PEP 675 – Arbitrary Literal String Type">PEP 675</a>.
While both are attempting to provide a way to have safer code, they are doing so in different ways.
<a class="pep reference internal" href="../pep-0675/" title="PEP 675 – Arbitrary Literal String Type">PEP 675</a> provides a way to find potential security issues via static analysis.
It does so by providing a way for the type checker to flag sections of code that are using
dynamic strings incorrectly. This requires a user to actually run a static analysis type checker such as mypy.</p>
<p>If <a class="pep reference internal" href="../pep-0675/" title="PEP 675 – Arbitrary Literal String Type">PEP 675</a> tells you that you are violating a type check, it is up to the programmer to know how to handle the dynamic-ness of the string.
This PEP provides a safer alternative to f-strings at runtime.
If a user recieves a type-error, changing an existing f-string into a t-string could be an easy way to solve the problem.</p>
<p>t-strings enable safer code by correctly escaping the dynamic sections of strings, while maintaining the static portions.</p>
<p>This PEP also allows a way for a library/codebase to be safe, but it does so at runtime rather than
only during static analysis. For example, if a library wanted to ensure “only safe strings”, it
could check that the type of object passed in at runtime is a template literal:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">my_safe_function</span><span class="p">(</span><span class="n">string_like_object</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">string_like_object</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">TemplateLiteral</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Argument &#39;string_like_object&#39; must be a t-string&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>The two PEPs could also be used together by typing your function as accepting either a string literal or a template literal.
This way, your function can provide the same API for both static and dynamic strings:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">my_safe_function</span><span class="p">(</span><span class="n">string_like_object</span><span class="p">:</span> <span class="n">LiteralString</span> <span class="o">|</span> <span class="n">TemplateLiteral</span><span class="p">):</span>
    <span class="o">...</span>
</pre></div>
</div>
</section>
<section id="discussion">
<h2><a class="toc-backref" href="#discussion" role="doc-backlink">Discussion</a></h2>
<p>Refer to <a class="pep reference internal" href="../pep-0498/" title="PEP 498 – Literal String Interpolation">PEP 498</a> for previous discussion, as several of the points there
also apply to this PEP.</p>
<section id="support-for-binary-interpolation">
<h3><a class="toc-backref" href="#support-for-binary-interpolation" role="doc-backlink">Support for binary interpolation</a></h3>
<p>As f-strings don’t handle byte strings, neither will t-strings.</p>
</section>
<section id="interoperability-with-str-only-interfaces">
<h3><a class="toc-backref" href="#interoperability-with-str-only-interfaces" role="doc-backlink">Interoperability with str-only interfaces</a></h3>
<p>For interoperability with interfaces that only accept strings, interpolation
templates can still be prerendered with <code class="docutils literal notranslate"><span class="pre">format</span></code>, rather than delegating the
rendering to the called function.</p>
<p>This reflects the key difference from <a class="pep reference internal" href="../pep-0498/" title="PEP 498 – Literal String Interpolation">PEP 498</a>, which <em>always</em> eagerly applies
the default rendering, without any way to delegate the choice of renderer to
another section of the code.</p>
</section>
<section id="preserving-the-raw-template-string">
<h3><a class="toc-backref" href="#preserving-the-raw-template-string" role="doc-backlink">Preserving the raw template string</a></h3>
<p>Earlier versions of this PEP failed to make the raw template string available
on the template literal. Retaining it makes it possible to provide a more
attractive template representation, as well as providing the ability to
precisely reconstruct the original string, including both the expression text
and the details of any eagerly rendered substitution fields in format specifiers.</p>
</section>
<section id="creating-a-rich-object-rather-than-a-global-name-lookup">
<h3><a class="toc-backref" href="#creating-a-rich-object-rather-than-a-global-name-lookup" role="doc-backlink">Creating a rich object rather than a global name lookup</a></h3>
<p>Earlier versions of this PEP used an <code class="docutils literal notranslate"><span class="pre">__interpolate__</span></code> builtin, rather than
a creating a new kind of object for later consumption by interpolation
functions. Creating a rich descriptive object with a useful default renderer
made it much easier to support customisation of the semantics of interpolation.</p>
</section>
<section id="building-atop-f-strings-rather-than-replacing-them">
<h3><a class="toc-backref" href="#building-atop-f-strings-rather-than-replacing-them" role="doc-backlink">Building atop f-strings rather than replacing them</a></h3>
<p>Earlier versions of this PEP attempted to serve as a complete substitute for
<a class="pep reference internal" href="../pep-0498/" title="PEP 498 – Literal String Interpolation">PEP 498</a> (f-strings) . With the acceptance of that PEP and the more recent <a class="pep reference internal" href="../pep-0701/" title="PEP 701 – Syntactic formalization of f-strings">PEP 701</a>,
this PEP can now build a more flexible delayed rendering capability
on top of the existing f-string eager rendering.</p>
<p>Assuming the presence of f-strings as a supporting capability simplified a
number of aspects of the proposal in this PEP (such as how to handle substitution
fields in format specifiers)</p>
</section>
<section id="deferring-consideration-of-possible-use-in-i18n-use-cases">
<h3><a class="toc-backref" href="#deferring-consideration-of-possible-use-in-i18n-use-cases" role="doc-backlink">Deferring consideration of possible use in i18n use cases</a></h3>
<p>The initial motivating use case for this PEP was providing a cleaner syntax
for i18n translation, as that requires access to the original unmodified
template. As such, it focused on compatibility with the substitution syntax used
in Python’s <code class="docutils literal notranslate"><span class="pre">string.Template</span></code> formatting and Mozilla’s l20n project.</p>
<p>However, subsequent discussion revealed there are significant additional
considerations to be taken into account in the i18n use case, which don’t
impact the simpler cases of handling interpolation into security sensitive
contexts (like HTML, system shells, and database queries), or producing
application debugging messages in the preferred language of the development
team (rather than the native language of end users).</p>
<p>Due to the original design of the <code class="docutils literal notranslate"><span class="pre">str.format</span></code> substitution syntax in <a class="pep reference internal" href="../pep-3101/" title="PEP 3101 – Advanced String Formatting">PEP 3101</a> being inspired by C#’s string formatting syntax, the specific field
substitution syntax used in <a class="pep reference internal" href="../pep-0498/" title="PEP 498 – Literal String Interpolation">PEP 498</a> is consistent not only with Python’s own <code class="docutils literal notranslate"><span class="pre">str.format</span></code> syntax, but also with string formatting in C#, including the
native “$-string” interpolation syntax introduced in C# 6.0 (released in July
2015).  The related <code class="docutils literal notranslate"><span class="pre">IFormattable</span></code> interface in C# forms the basis of a
<a class="reference external" href="https://msdn.microsoft.com/en-us/library/system.iformattable.aspx">number of elements</a> of C#’s internationalization and localization
support.</p>
<p>This means that while this particular substitution syntax may not
currently be widely used for translation of <em>Python</em> applications (losing out
to traditional %-formatting and the designed-specifically-for-i18n
<code class="docutils literal notranslate"><span class="pre">string.Template</span></code> formatting), it <em>is</em> a popular translation format in the
wider software development ecosystem (since it is already the preferred
format for translating C# applications).</p>
</section>
</section>
<section id="acknowledgements">
<h2><a class="toc-backref" href="#acknowledgements" role="doc-backlink">Acknowledgements</a></h2>
<ul class="simple">
<li>Eric V. Smith for creating <a class="pep reference internal" href="../pep-0498/" title="PEP 498 – Literal String Interpolation">PEP 498</a> and demonstrating the feasibility of
arbitrary expression substitution in string interpolation</li>
<li>Barry Warsaw, Armin Ronacher, and Mike Miller for their contributions to
exploring the feasibility of using this model of delayed rendering in i18n
use cases (even though the ultimate conclusion was that it was a poor fit,
at least for current approaches to i18n in Python)</li>
</ul>
</section>
<section id="references">
<h2><a class="toc-backref" href="#references" role="doc-backlink">References</a></h2>
<ul class="simple">
<li><a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#printf-style-string-formatting">%-formatting</a></li>
<li><a class="reference external" href="https://docs.python.org/3/library/string.html#formatstrings">str.format</a></li>
<li><a class="reference external" href="https://docs.python.org/3/library/string.html#template-strings">string.Template documentation</a></li>
<li><a class="pep reference internal" href="../pep-0215/" title="PEP 215 – String Interpolation">PEP 215</a>: String Interpolation</li>
<li><a class="pep reference internal" href="../pep-0292/" title="PEP 292 – Simpler String Substitutions">PEP 292</a>: Simpler String Substitutions</li>
<li><a class="pep reference internal" href="../pep-3101/" title="PEP 3101 – Advanced String Formatting">PEP 3101</a>: Advanced String Formatting</li>
<li><a class="pep reference internal" href="../pep-0498/" title="PEP 498 – Literal String Interpolation">PEP 498</a>: Literal string formatting</li>
<li><a class="pep reference internal" href="../pep-0675/" title="PEP 675 – Arbitrary Literal String Type">PEP 675</a>: Arbitrary Literal String Type</li>
<li><a class="pep reference internal" href="../pep-0701/" title="PEP 701 – Syntactic formalization of f-strings">PEP 701</a>: Syntactic formalization of f-strings</li>
<li><a class="reference external" href="https://docs.microsoft.com/en-us/dotnet/csharp/language-reference/tokens/interpolated">FormattableString and C# native string interpolation</a></li>
<li><a class="reference external" href="https://docs.microsoft.com/en-us/dotnet/api/system.iformattable">IFormattable interface in C# (see remarks for globalization notes)</a></li>
<li><a class="reference external" href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Template_literals">TemplateLiterals in Javascript</a></li>
<li><a class="reference external" href="https://docs.julialang.org/en/v1/manual/running-external-programs/">Running external commands in Julia</a></li>
</ul>
</section>
<section id="copyright">
<h2><a class="toc-backref" href="#copyright" role="doc-backlink">Copyright</a></h2>
<p>This document is placed in the public domain or under the
CC0-1.0-Universal license, whichever is more permissive.</p>
</section>
</section>
<hr class="docutils" />
<p>Source: <a class="reference external" href="https://github.com/python/peps/blob/main/peps/pep-0501.rst">https://github.com/python/peps/blob/main/peps/pep-0501.rst</a></p>
<p>Last modified: <a class="reference external" href="https://github.com/python/peps/commits/main/peps/pep-0501.rst">2024-08-12 16:04:13 GMT</a></p>

        </article>
        <nav id="pep-sidebar">
            <h2>Contents</h2>
            <ul>
<li><a class="reference internal" href="#abstract">Abstract</a></li>
<li><a class="reference internal" href="#motivation">Motivation</a></li>
<li><a class="reference internal" href="#proposal">Proposal</a><ul>
<li><a class="reference internal" href="#summary-of-differences-from-f-strings">Summary of differences from f-strings</a></li>
</ul>
</li>
<li><a class="reference internal" href="#rationale">Rationale</a></li>
<li><a class="reference internal" href="#specification">Specification</a><ul>
<li><a class="reference internal" href="#conversion-specifiers">Conversion specifiers</a></li>
<li><a class="reference internal" href="#writing-custom-renderers">Writing custom renderers</a></li>
<li><a class="reference internal" href="#expression-evaluation">Expression evaluation</a></li>
<li><a class="reference internal" href="#handling-code-injection-attacks">Handling code injection attacks</a></li>
<li><a class="reference internal" href="#format-specifiers">Format specifiers</a></li>
<li><a class="reference internal" href="#error-handling">Error handling</a></li>
</ul>
</li>
<li><a class="reference internal" href="#renderer-for-shell-escaping-added-to-shlex">Renderer for shell escaping added to shlex</a></li>
<li><a class="reference internal" href="#changes-to-subprocess-module">Changes to subprocess module</a></li>
<li><a class="reference internal" href="#possible-integration-with-the-logging-module">Possible integration with the logging module</a></li>
<li><a class="reference internal" href="#comparison-to-pep-675">Comparison to PEP 675</a></li>
<li><a class="reference internal" href="#discussion">Discussion</a><ul>
<li><a class="reference internal" href="#support-for-binary-interpolation">Support for binary interpolation</a></li>
<li><a class="reference internal" href="#interoperability-with-str-only-interfaces">Interoperability with str-only interfaces</a></li>
<li><a class="reference internal" href="#preserving-the-raw-template-string">Preserving the raw template string</a></li>
<li><a class="reference internal" href="#creating-a-rich-object-rather-than-a-global-name-lookup">Creating a rich object rather than a global name lookup</a></li>
<li><a class="reference internal" href="#building-atop-f-strings-rather-than-replacing-them">Building atop f-strings rather than replacing them</a></li>
<li><a class="reference internal" href="#deferring-consideration-of-possible-use-in-i18n-use-cases">Deferring consideration of possible use in i18n use cases</a></li>
</ul>
</li>
<li><a class="reference internal" href="#acknowledgements">Acknowledgements</a></li>
<li><a class="reference internal" href="#references">References</a></li>
<li><a class="reference internal" href="#copyright">Copyright</a></li>
</ul>

            <br>
            <a id="source" href="https://github.com/python/peps/blob/main/peps/pep-0501.rst">Page Source (GitHub)</a>
        </nav>
    </section>
    <script src="../_static/colour_scheme.js"></script>
    <script src="../_static/wrap_tables.js"></script>
    <script src="../_static/sticky_banner.js"></script>
</body>
</html>